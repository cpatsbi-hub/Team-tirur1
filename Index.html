<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Mission Malappuram Connect-Team Tirur 1 </title>

<!-- Inline manifest (data URI) so single-file -->
<link rel="manifest" href='data:application/manifest+json,{"name":"Mission Malappuram Connect","short_name":"MMC","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#00796b","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22256%22 height=%22256%22 viewBox=%220 0 24 24%22%3E%3Crect width=%2224%22 height=%2224%22 fill=%22%2300796b%22 rx=%224%22/%3E%3Ctext x=%2212%22 y=%2216%22 font-size=%229%22 font-family=%22Arial%22 fill=%22%23fff%22 text-anchor=%22middle%22%3EMMC%3C/text%3E%3C/svg%3E","sizes":"256x256","type":"image/svg+xml"}]}'>

<meta name="theme-color" content="#00796b">

<style>
:root{--accent:#00796b;--muted:#6b7280;--danger:#d32f2f}
html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#f7fbfa;overflow:hidden}
.wrap{height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:18px}
.card{width:100%;max-width:720px;background:#fff;border-radius:14px;padding:14px;box-shadow:0 8px 30px rgba(10,30,20,.06)}
.header{display:flex;align-items:center}
.brand{font-weight:900;color:var(--accent);font-size:20px}
.subtitle{margin-left:auto;color:var(--muted);font-size:13px}
.fields{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
label{font-weight:700;color:var(--muted);font-size:13px;margin-bottom:6px;display:block}
input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #e6eef0;background:#fbfeff;font-size:15px;box-sizing:border-box}
input[readonly]{background:#f3f6f5}
.row{display:flex;gap:8px;align-items:center}
.btn{padding:12px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
.btn-primary{background:var(--accent);color:#fff}
.btn-soft{background:#eef6f4;color:var(--accent)}
.btn-ghost{background:transparent;border:1px solid #e6eef0;color:var(--accent)}
.install-wrap{display:flex;gap:8px;align-items:center}
.install-btn{background:#ffb300;color:#000;padding:8px 10px;border-radius:10px;font-weight:800;border:0;cursor:pointer}
.status{font-weight:700;color:var(--accent);font-size:13px}
.error{color:var(--danger);font-weight:800}
.full{grid-column:1/-1}
.actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
@media(max-width:520px){.fields{grid-template-columns:1fr}.actions{flex-direction:column;align-items:stretch}}
.note{font-size:12px;color:var(--muted);margin-top:6px}
.small{font-size:13px;padding:10px 12px}
</style>
</head>
<body>
  <div class="wrap">
    <main class="card" role="main" aria-labelledby="brandTitle">
      <div class="header">
        <div id="brandTitle" class="brand">Mission Malappuram Connect</div>
        <div class="subtitle">Connect • Capture • Act</div>
      </div>

      <!-- install prompt area -->
      <div style="margin-top:10px;display:flex;justify-content:flex-end;">
        <div id="installArea" class="install-wrap" aria-hidden="true" style="display:none;">
          <button id="installBtn" class="install-btn">Install App</button>
        </div>
      </div>

      <form id="form" onsubmit="return false;" autocomplete="off">
        <div class="fields">
          <div>
            <label for="name">Name</label>
            <input id="name" type="text" inputmode="text" placeholder="Full name" />
          </div>

          <div>
            <label for="mobile">Mobile number</label>
            <input id="mobile" type="tel" inputmode="numeric" placeholder="10-digit mobile" maxlength="10" />
          </div>

          <div class="full">
            <label for="gst">GST No. (optional)</label>
            <input id="gst" type="text" placeholder="GST number" />
          </div>

          <div>
            <label for="activity">Type of activity</label>
            <input id="activity" type="text" placeholder="Shop / Service / Trade" />
          </div>

          <div>
            <label for="size">Size</label>
            <select id="size" aria-label="Size">
              <option value="Small">Small</option>
              <option value="Medium">Medium</option>
              <option value="Large">Large</option>
            </select>
          </div>

          <div class="full">
            <label>Location</label>
            <div class="row">
              <input id="locationDisplay" type="text" placeholder="Not captured" readonly />
              <button id="captureBtn" class="btn btn-soft small" type="button">Capture location</button>
            </div>
            <div class="note">Captured location will be sent with the message. Please allow location permission.</div>
          </div>
        </div>

        <div class="actions">
          <div style="flex:1"><div id="msg" class="status">Please capture location</div></div>
          <button id="copyBtn" class="btn btn-ghost small" type="button">Copy</button>
          <button id="shareBtn" class="btn btn-primary small" type="button" disabled>Share to WhatsApp</button>
        </div>
      </form>
    </main>
  </div>

<script>
/* ---------- Form & location behavior ---------- */
const nameInput = document.getElementById('name');
const mobileInput = document.getElementById('mobile');
const gstInput = document.getElementById('gst');
const activityInput = document.getElementById('activity');
const sizeInput = document.getElementById('size');
const locationDisplay = document.getElementById('locationDisplay');
const captureBtn = document.getElementById('captureBtn');
const shareBtn = document.getElementById('shareBtn');
const copyBtn = document.getElementById('copyBtn');
const msgEl = document.getElementById('msg');

let currentLocation = null;

function setMsg(text, isError=false){
  msgEl.textContent = text;
  msgEl.className = isError ? 'error' : 'status';
}

function validateMobile(v){
  const d = (v||'').replace(/\D/g,'');
  return d.length === 10;
}

function buildMessage(){
  const name = (nameInput.value||'').trim();
  const mobile = (mobileInput.value||'').replace(/\D/g,'');
  const gst = (gstInput.value||'').trim() || '-';
  const activity = (activityInput.value||'').trim() || '-';
  const size = (sizeInput.value||'') || '-';
  if(!name){ setMsg('Enter name', true); return null; }
  if(!validateMobile(mobile)){ setMsg('Enter 10-digit mobile', true); return null; }
  if(!currentLocation){ setMsg('Capture location first', true); return null; }
  const maps = `https://maps.google.com/?q=${currentLocation.lat},${currentLocation.lng}`;
  const lines = [
    '*Mission Malappuram Connect*',
    '',
    `*Name:* ${name}`,
    `*Mobile:* ${mobile}`,
    `*GST:* ${gst}`,
    `*Activity:* ${activity}`,
    `*Size:* ${size}`,
    `*Location:* ${maps}`,
    '',
    `*Captured on:* ${new Date().toLocaleString()}`
  ];
  return lines.join('\n');
}

function updateButtons(){
  const nameOk = (nameInput.value||'').trim().length > 0;
  const mobileOk = validateMobile(mobileInput.value);
  const locOk = currentLocation !== null;
  if(!nameOk){ setMsg('Enter name', true); shareBtn.disabled = true; return; }
  if(!mobileOk){ setMsg('Enter 10-digit mobile', true); shareBtn.disabled = true; return; }
  if(!locOk){ setMsg('Location not captured. Tap Capture location.', true); shareBtn.disabled = true; return; }
  setMsg('Ready to share');
  shareBtn.disabled = false;
}
[nameInput, mobileInput].forEach(i => i.addEventListener('input', updateButtons));

captureBtn.addEventListener('click', async () => {
  if(!navigator.geolocation){ setMsg('Geolocation not supported', true); return; }
  setMsg('Requesting location...');
  captureBtn.disabled = true; captureBtn.textContent = 'Capturing...';
  try{
    const pos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, {enableHighAccuracy:true, timeout:25000, maximumAge:0}));
    currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    locationDisplay.value = `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
    setMsg('Location captured');
  }catch(err){
    console.error(err);
    if(err && err.code === 1){ setMsg('Permission denied. Allow location in browser settings.', true); }
    else if(err && err.code === 2){ setMsg('Location unavailable. Move to open area and retry.', true); }
    else if(err && err.code === 3){ setMsg('Location timed out. Retry capturing.', true); }
    else setMsg('Failed to capture location. Ensure GPS ON & page served over HTTPS', true);
    currentLocation = null;
    locationDisplay.value = 'Not captured';
  }finally{
    captureBtn.disabled = false; captureBtn.textContent = 'Capture location';
    updateButtons();
  }
});

shareBtn.addEventListener('click', async () => {
  const message = buildMessage();
  if(!message) return;
  // Web Share API preferred
  if(navigator.share){
    try{
      await navigator.share({text: message, title: 'Mission Malappuram Connect'});
      return;
    }catch(e){
      // continue to whatsapp fallbacks
    }
  }
  const encoded = encodeURIComponent(message);
  const native = `whatsapp://send?text=${encoded}`;
  const web = `https://wa.me/?text=${encoded}`;
  // attempt native then fallback to web
  try{ location.href = native; }catch(e){ window.open(web, '_blank'); }
  setTimeout(()=>{ try{ location.href = web; }catch(e){ window.open(web, '_blank'); } }, 900);
});

copyBtn.addEventListener('click', async () => {
  const message = buildMessage();
  if(!message) return;
  try{ await navigator.clipboard.writeText(message); setMsg('Copied to clipboard'); }catch(e){
    const ta = document.createElement('textarea'); ta.value = message; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); setMsg('Copied to clipboard'); }catch(err){ setMsg('Copy failed', true); } ta.remove();
  }
});

/* ---------- Inline service worker for offline caching ---------- */
if('serviceWorker' in navigator){
  try{
    const swCode = `
      const CACHE = 'mmc-v1';
      const FILES = ['/', '/index.html'];
      self.addEventListener('install', e => {
        e.waitUntil(caches.open(CACHE).then(c => c.addAll(FILES)).catch(()=>{}));
        self.skipWaiting();
      });
      self.addEventListener('activate', e => {
        e.waitUntil(caches.keys().then(keys => Promise.all(keys.map(k => k!==CACHE?caches.delete(k):null))));
        self.clients.claim();
      });
      self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
      });
    `;
    const blob = new Blob([swCode], {type:'application/javascript'});
    const swUrl = URL.createObjectURL(blob);
    window.addEventListener('load', ()=> navigator.serviceWorker.register(swUrl).catch(()=>{}));
  }catch(err){
    // ignore
  }
}

/* ---------- Install prompt handling ---------- */
let deferredPrompt = null;
const installArea = document.getElementById('installArea');
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent Chrome's mini-infobar
  e.preventDefault();
  deferredPrompt = e;
  installArea.style.display = 'flex';
  installArea.setAttribute('aria-hidden','false');
});

installBtn.addEventListener('click', async () => {
  if(!deferredPrompt) {
    // Fallback: instruct user
    alert('To install: open Chrome menu (⋮) → Add to Home screen');
    return;
  }
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  if(choice.outcome === 'accepted'){
    // installed
    installArea.style.display = 'none';
    deferredPrompt = null;
  } else {
    // dismissed
  }
});

/* Fallback: if browser does not send beforeinstallprompt, show a small hint after page load */
window.addEventListener('load', () => {
  // show short hint if no install prompt event came
  setTimeout(()=> {
    if(installArea.style.display === 'none' || installArea.style.display === '') {
      // don't force, but expose a small manual hint button for users on unsupported browsers
      // show the area with a helpful action to open browser menu
      installArea.style.display = 'none'; // keep hidden unless browser supports prompt
    }
  }, 2000);
});
</script>
</body>
</html>